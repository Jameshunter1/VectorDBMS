name: CI/CD Pipeline

on:
 push:
  branches: [main, master, develop]
 pull_request:
  branches: [main, master, develop]
permissions:
 contents: read
 security-events: write

jobs:
 # ============================================================================
 # Build and Test - Windows (MSVC)
 # ============================================================================
 build-windows:
  runs-on: windows-latest
  strategy:
   matrix:
    build_type: [Debug, Release]

  steps:
   - uses: actions/checkout@v4

   - name: Setup MSVC
     uses: ilammy/msvc-dev-cmd@v1

   - name: Configure CMake
     run: |
      cmake -B build/ci-${{ matrix.build_type }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCORE_ENGINE_BUILD_TESTS=ON -DCORE_ENGINE_BUILD_BENCHMARKS=ON

   - name: Build
     run: |
      cmake --build build/ci-${{ matrix.build_type }} --config ${{ matrix.build_type }} -j

   - name: Run Tests
     timeout-minutes: 10
     run: |
      ctest --test-dir build/ci-${{ matrix.build_type }} -C ${{ matrix.build_type }} --output-on-failure --timeout 120

   - name: Run Benchmarks (Release only)
     if: matrix.build_type == 'Release'
     continue-on-error: true  # Don't fail CI if benchmarks have issues
     run: |
      .\build\ci-Release\benchmarks\Release\core_engine_benchmarks.exe --benchmark_min_time=0.01s

 # ============================================================================
 # Build and Test - Linux (GCC)
 # ============================================================================
 build-linux-gcc:
  runs-on: ubuntu-latest
  strategy:
   matrix:
    build_type: [Debug, Release]

  steps:
   - uses: actions/checkout@v4

   - name: Install Dependencies
     run: |
      sudo apt-get update
      sudo apt-get install -y cmake ninja-build g++-13

   - name: Configure CMake
     run: |
      cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -G Ninja -DCORE_ENGINE_BUILD_TESTS=ON -DCMAKE_CXX_COMPILER=g++-13

   - name: Build
     run: |
      cmake --build build -j

   - name: Run Tests
     timeout-minutes: 10
     run: |
      ctest --test-dir build --output-on-failure --timeout 120

 # ============================================================================
 # Build and Test - Linux (Clang)
 # ============================================================================
 build-linux-clang:
  runs-on: ubuntu-latest
  strategy:
   matrix:
    build_type: [Debug, Release]

  steps:
   - uses: actions/checkout@v4

   - name: Install Dependencies
     run: |
      sudo apt-get update
      sudo apt-get install -y cmake ninja-build clang-17

   - name: Configure CMake
     run: |
      cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_COMPILER=clang++-17 -G Ninja \
            -DCORE_ENGINE_BUILD_TESTS=ON

   - name: Build
     run: |
      cmake --build build -j

   - name: Run Tests
     timeout-minutes: 10
     run: |
      ctest --test-dir build --output-on-failure --timeout 120

 # ============================================================================
 # Code Quality - Format Check
 # ============================================================================
 format-check:
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v4

   - name: Install clang-format
     run: |
      sudo apt-get update
      sudo apt-get install -y clang-format-17

   - name: Check Code Formatting
     run: |
      find src/include src/lib src/apps tests benchmarks -name '*.cpp' -o -name '*.hpp' | \
      xargs clang-format-17 --dry-run --Werror

 # ============================================================================
 # Code Quality - Static Analysis
 # ============================================================================
 static-analysis:
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v4

   - name: Install cppcheck
     run: |
      sudo apt-get update
      sudo apt-get install -y cppcheck

   - name: Run cppcheck
     run: |
      cppcheck --enable=warning,style,performance,portability \
               --suppress=missingIncludeSystem \
               --inline-suppr \
               --error-exitcode=0 \
               -I src/include src/lib/ src/apps/ || true

 # ============================================================================
 # Security - Dependency Scan
 # ============================================================================
 security-scan:
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v4

   - name: Run Trivy vulnerability scanner
     uses: aquasecurity/trivy-action@master
     with:
      scan-type: "fs"
      scan-ref: "."
      format: "sarif"
      output: "trivy-results.sarif"

   - name: Upload Trivy results to GitHub Security
     uses: github/codeql-action/upload-sarif@v4
     with:
      sarif_file: "trivy-results.sarif"
